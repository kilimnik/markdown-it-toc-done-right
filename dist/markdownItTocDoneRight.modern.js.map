{"version":3,"file":"markdownItTocDoneRight.modern.js","sources":["../index.js"],"sourcesContent":["'use strict'\n\nfunction slugify (x) {\n  return encodeURIComponent(String(x).trim().toLowerCase().replace(/\\s+/g, '-'))\n}\n\nfunction htmlencode (x) {\n  /*\n    // safest, delegate task to native -- IMPORTANT: enabling this breaks both jest and runkit, but with browserify it's fine\n    if (document && document.createElement) {\n      const el = document.createElement(\"div\")\n      el.innerText = x\n      return el.innerHTML\n    }\n  */\n\n  return String(x)\n    .replace(/&/g, '&amp;')\n    .replace(/\"/g, '&quot;')\n    .replace(/'/g, '&#39;')\n    .replace(/</g, '&lt;')\n    .replace(/>/g, '&gt;')\n}\n\nfunction tocPlugin (md, options) {\n  options = Object.assign({}, {\n    placeholder: '(\\\\$\\\\{toc\\\\}|\\\\[\\\\[?_?toc_?\\\\]?\\\\]|\\\\$\\\\<toc(\\\\{[^}]*\\\\})\\\\>)',\n    slugify: slugify,\n    uniqueSlugStartIndex: 1,\n    containerClass: 'table-of-contents',\n    containerId: undefined,\n    listClass: undefined,\n    itemClass: undefined,\n    linkClass: undefined,\n    level: 1,\n    listType: 'ol',\n    format: undefined,\n    exclude: [],\n    callback: undefined/* function(html, ast) {} */\n  }, options)\n\n  let ast\n  const pattern = new RegExp('^' + options.placeholder + '$', 'i')\n\n  function toc (state, startLine, endLine, silent) {\n    let token\n    const pos = state.bMarks[startLine] + state.tShift[startLine]\n    const max = state.eMarks[startLine]\n\n    // use whitespace as a line tokenizer and extract the first token\n    // to test against the placeholder anchored pattern, rejecting if false\n    const lineFirstToken = state.src.slice(pos, max).split(' ')[0]\n    if (!pattern.test(lineFirstToken)) return false\n\n    if (silent) return true\n\n    const matches = pattern.exec(lineFirstToken)\n    let inlineOptions = {}\n    if (matches !== null && matches.length === 3) {\n      try {\n        inlineOptions = JSON.parse(matches[2])\n      } catch (ex) {\n        // silently ignore inline options\n      }\n    }\n\n    state.line = startLine + 1\n\n    token = state.push('tocOpen', 'nav', 1)\n    token.markup = ''\n    token.map = [startLine, state.line]\n    token.inlineOptions = inlineOptions\n\n    token = state.push('tocBody', '', 0)\n    token.markup = ''\n    token.map = [startLine, state.line]\n    token.inlineOptions = inlineOptions\n    token.children = []\n\n    token = state.push('tocClose', 'nav', -1)\n    token.markup = ''\n\n    return true\n  }\n\n  md.renderer.rules.tocOpen = function (tokens, idx/* , options, env, renderer */) {\n    let _options = Object.assign({}, options)\n    if (tokens && idx >= 0) {\n      const token = tokens[idx]\n      _options = Object.assign(_options, token.inlineOptions)\n    }\n    const id = _options.containerId ? ` id=\"${htmlencode(_options.containerId)}\"` : ''\n    return `<nav${id} class=\"${htmlencode(_options.containerClass)}\">`\n  }\n\n  md.renderer.rules.tocClose = function (/* tokens, idx, options, env, renderer */) {\n    return '</nav>'\n  }\n\n  md.renderer.rules.tocBody = function (tokens, idx/* , options, env, renderer */) {\n    let _options = Object.assign({}, options)\n    if (tokens && idx >= 0) {\n      const token = tokens[idx]\n      _options = Object.assign(_options, token.inlineOptions)\n    }\n\n    const uniques = {}\n    function unique (s) {\n      let u = s\n      let i = _options.uniqueSlugStartIndex\n      while (Object.prototype.hasOwnProperty.call(uniques, u)) u = `${s}-${i++}`\n      uniques[u] = true\n      return u\n    }\n\n    const isLevelSelectedNumber = selection => level => level >= selection\n    const isLevelSelectedArray = selection => level => selection.includes(level)\n\n    const isLevelSelected = Array.isArray(_options.level)\n      ? isLevelSelectedArray(_options.level)\n      : isLevelSelectedNumber(_options.level)\n\n    function ast2html (tree) {\n      const listClass = _options.listClass ? ` class=\"${htmlencode(_options.listClass)}\"` : ''\n      const itemClass = _options.itemClass ? ` class=\"${htmlencode(_options.itemClass)}\"` : ''\n      const linkClass = _options.linkClass ? ` class=\"${htmlencode(_options.linkClass)}\"` : ''\n\n      if (tree.c.length === 0) return ''\n\n      let buffer = ''\n      if (!tree.e) {\n        if (tree.l === 0 || isLevelSelected(tree.l)) {\n          buffer += (`<${htmlencode(_options.listType) + listClass}>`)\n        }\n        tree.c.forEach(node => {\n          if (!node.e) {\n            if (isLevelSelected(node.l)) {\n              buffer += (`<li${itemClass}><a${linkClass} href=\"#${unique(options.slugify(node.n))}\">${typeof _options.format === 'function' ? _options.format(node.n, htmlencode) : htmlencode(node.n)}</a>${ast2html(node)}</li>`)\n            } else {\n              buffer += ast2html(node)\n            }\n          }\n        })\n        if (tree.l === 0 || isLevelSelected(tree.l)) {\n          buffer += (`</${htmlencode(_options.listType)}>`)\n        }\n      }\n      return buffer\n    }\n\n    return ast2html(ast)\n  }\n\n  const isExcludedFunc = exclude => label => exclude(label)\n  const isExcludedArray = exclude => label => exclude.includes(label)\n\n  const isExcluded = Array.isArray(options.exclude)\n    ? isExcludedArray(options.exclude)\n    : isExcludedFunc(options.exclude)\n\n  function headings2ast (tokens) {\n    const ast = { l: 0, n: '', c: [], e: false }\n    const stack = [ast]\n\n    for (let i = 0, iK = tokens.length; i < iK; i++) {\n      const token = tokens[i]\n      if (token.type === 'heading_open') {\n        const key = (\n          tokens[i + 1]\n            .children\n            .filter(function (token) { return token.type === 'text' || token.type === 'code_inline' })\n            .reduce(function (s, t) { return s + t.content }, '')\n        )\n\n        const node = {\n          l: parseInt(token.tag.substr(1), 10),\n          n: key,\n          c: [],\n          e: isExcluded(key.trim())\n        }\n\n        if (node.l > stack[0].l) {\n          stack[0].c.push(node)\n          stack.unshift(node)\n        } else if (node.l === stack[0].l) {\n          stack[1].c.push(node)\n          stack[0] = node\n        } else {\n          while (node.l <= stack[0].l) stack.shift()\n          stack[0].c.push(node)\n          stack.unshift(node)\n        }\n      }\n    }\n\n    return ast\n  }\n\n  md.core.ruler.push('generateTocAst', function (state) {\n    const tokens = state.tokens\n    ast = headings2ast(tokens)\n\n    if (typeof options.callback === 'function') {\n      options.callback(\n        md.renderer.rules.tocOpen() + md.renderer.rules.tocBody() + md.renderer.rules.tocClose(),\n        ast\n      )\n    }\n  })\n\n  md.block.ruler.before('heading', 'toc', toc, {\n    alt: ['paragraph', 'reference', 'blockquote']\n  })\n}\n\nexport default tocPlugin\n"],"names":["slugify","x","encodeURIComponent","String","trim","toLowerCase","replace","htmlencode","md","options","ast","Object","assign","placeholder","uniqueSlugStartIndex","containerClass","containerId","undefined","listClass","itemClass","linkClass","level","listType","format","exclude","callback","pattern","RegExp","renderer","rules","tocOpen","tokens","idx","_options","inlineOptions","tocClose","tocBody","uniques","isLevelSelected","Array","isArray","selection","includes","isLevelSelectedNumber","ast2html","tree","c","length","buffer","e","l","forEach","node","s","u","i","prototype","hasOwnProperty","call","unique","n","isExcluded","label","isExcludedFunc","core","ruler","push","state","stack","iK","token","type","key","children","filter","reduce","t","content","parseInt","tag","substr","unshift","shift","headings2ast","block","before","startLine","endLine","silent","lineFirstToken","src","slice","bMarks","tShift","eMarks","split","test","matches","exec","JSON","parse","ex","line","markup","map","alt"],"mappings":"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"}